# Maintenance Service Database Structure

## Overview

The SAMFMS Maintenance Service uses MongoDB as its primary database, leveraging the Motor async driver for high-performance operations. The database is designed for scalability, consistency, and comprehensive maintenance management.

## Database Configuration

### Connection Details

- **Database Name**: `samfms_maintenance` (from `DATABASE_MAINTENANCE` env var)
- **Connection URL**: Uses `MONGODB_URL` environment variable
- **Driver**: Motor (Async MongoDB driver for Python)
- **Connection Pool**: 5-50 connections (configurable)
- **Retry Logic**: Automatic retries with exponential backoff

### Connection Settings

```python
# Connection pool settings
max_pool_size = 50
min_pool_size = 5
server_selection_timeout = 5000ms
connect_timeout = 10000ms
retry_writes = True
retry_reads = True
max_idle_time = 30000ms
wait_queue_timeout = 5000ms
```

## Database Schema

### 1. Maintenance Records Collection (`maintenance_records`)

**Primary collection for all maintenance activities**

```javascript
{
  "_id": ObjectId("..."),
  "vehicle_id": "vehicle_001",                    // References vehicle in vehicles DB
  "maintenance_type": "preventive",               // Enum: preventive, corrective, scheduled, emergency, inspection
  "status": "scheduled",                          // Enum: scheduled, in_progress, completed, cancelled, overdue
  "priority": "medium",                           // Enum: low, medium, high, critical

  // Scheduling Information
  "scheduled_date": ISODate("2025-07-25T10:00:00Z"),
  "estimated_duration": 2,                        // Hours
  "actual_start_date": ISODate("2025-07-25T10:30:00Z"),
  "actual_completion_date": ISODate("2025-07-25T12:30:00Z"),

  // Description and Details
  "title": "Engine Oil Change",
  "description": "Replace engine oil and filter",
  "work_performed": "Replaced 5L synthetic oil, new oil filter",
  "notes": "Vehicle running smoothly after service",

  // Cost Tracking
  "estimated_cost": 250.00,
  "actual_cost": 275.00,
  "labor_cost": 150.00,
  "parts_cost": 125.00,
  "other_costs": 0.00,

  // Personnel and Vendor Information
  "assigned_technician": "tech_001",
  "technician_name": "John Smith",
  "vendor_id": "vendor_001",
  "vendor_name": "QuickLube Services",
  "service_provider": "QuickLube Services",

  // Mileage Information
  "mileage_at_service": 50000,
  "next_service_mileage": 55000,
  "odometer_reading": 50123,

  // Parts and Materials
  "parts_used": [
    {
      "part_id": "part_001",
      "part_name": "Oil Filter",
      "quantity": 1,
      "unit_cost": 25.00,
      "total_cost": 25.00,
      "supplier": "AutoParts Inc"
    }
  ],
  "warranty_info": {
    "warranty_period": "6 months",
    "warranty_mileage": 5000,
    "warranty_expiry": ISODate("2026-01-25T00:00:00Z")
  },

  // Images and Documents
  "photos": [
    "/uploads/maintenance/maint_001_before.jpg",
    "/uploads/maintenance/maint_001_after.jpg"
  ],
  "documents": [
    "/uploads/maintenance/maint_001_invoice.pdf"
  ],

  // Metadata
  "created_at": ISODate("2025-07-17T10:00:00Z"),
  "updated_at": ISODate("2025-07-17T10:00:00Z"),
  "created_by": "user_001",
  "updated_by": "user_001",

  // Recurring Maintenance
  "is_recurring": false,
  "recurrence_interval": 90,                      // Days
  "recurrence_type": "time_based",
  "parent_schedule_id": "schedule_001",

  // Computed Fields (Generated by application)
  "is_overdue": false,
  "days_until_due": 8,
  "total_cost": 275.00
}
```

**Indexes:**

```javascript
// Primary indexes for performance
{ "vehicle_id": 1 }
{ "status": 1 }
{ "scheduled_date": 1 }
{ "maintenance_type": 1 }
{ "priority": 1 }
{ "created_at": -1 }

// Compound indexes for common queries
{ "vehicle_id": 1, "status": 1 }
{ "vehicle_id": 1, "scheduled_date": 1 }
{ "status": 1, "scheduled_date": 1 }
{ "vendor_id": 1, "created_at": -1 }
{ "assigned_technician": 1, "status": 1 }

// Text index for search functionality
{ "title": "text", "description": "text", "notes": "text" }
```

### 2. Maintenance Schedules Collection (`maintenance_schedules`)

**Templates for recurring maintenance**

```javascript
{
  "_id": ObjectId("..."),
  "vehicle_id": "vehicle_001",                    // Specific vehicle or null for all
  "vehicle_type": "truck",                        // Type-based scheduling

  // Schedule Details
  "name": "Oil Change Schedule",
  "description": "Regular oil changes every 5000km or 3 months",
  "maintenance_type": "preventive",
  "priority": "medium",

  // Interval Settings
  "interval_type": "hybrid",                      // time_based, mileage_based, or hybrid
  "interval_days": 90,                           // Days between services
  "interval_mileage": 5000,                      // Mileage between services

  // Cost Estimates
  "estimated_cost": 250.00,
  "estimated_duration": 2,

  // Notification Settings
  "advance_notice_days": 7,

  // Status
  "is_active": true,
  "created_at": ISODate("2025-07-17T10:00:00Z"),
  "updated_at": ISODate("2025-07-17T10:00:00Z")
}
```

**Indexes:**

```javascript
{ "vehicle_id": 1 }
{ "vehicle_type": 1 }
{ "is_active": 1 }
{ "maintenance_type": 1 }
```

### 3. License Records Collection (`license_records`)

**Vehicle and driver licenses/certifications**

```javascript
{
  "_id": ObjectId("..."),
  "entity_id": "vehicle_001",                     // Vehicle or driver ID
  "entity_type": "vehicle",                       // vehicle or driver
  "license_type": "vehicle_registration",         // Enum: various license types

  // License Details
  "license_number": "CA-123-456-GP",
  "license_description": "Vehicle Registration Certificate",
  "issue_date": ISODate("2025-01-01T00:00:00Z"),
  "expiry_date": ISODate("2026-01-01T00:00:00Z"),
  "issuing_authority": "Department of Transport",
  "issuing_location": "Cape Town",

  // Cost and Renewal Information
  "cost": 500.00,
  "renewal_cost": 500.00,
  "auto_renewal": false,
  "renewal_notice_days": 30,

  // Status and Validation
  "is_active": true,
  "is_valid": true,
  "validation_status": "verified",
  "last_verified": ISODate("2025-07-17T10:00:00Z"),

  // Documents
  "document_path": "/uploads/licenses/vehicle_001_registration.pdf",
  "document_type": "pdf",

  // Metadata
  "created_at": ISODate("2025-07-17T10:00:00Z"),
  "updated_at": ISODate("2025-07-17T10:00:00Z"),
  "created_by": "user_001",

  // Additional Information
  "notes": "Renewed for 2025",
  "restrictions": [],
  "conditions": []
}
```

**Indexes:**

```javascript
{ "entity_id": 1 }
{ "entity_type": 1 }
{ "license_type": 1 }
{ "expiry_date": 1 }
{ "is_active": 1 }
{ "entity_id": 1, "license_type": 1 }
{ "entity_type": 1, "expiry_date": 1 }
```

### 4. Notifications Collection (`notifications`)

**System notifications and alerts**

```javascript
{
  "_id": ObjectId("..."),
  "notification_type": "maintenance_reminder",    // Enum: various notification types
  "priority": "medium",
  "status": "pending",                            // pending, sent, failed

  // Recipient Information
  "recipient_id": "user_001",
  "recipient_type": "user",                       // user, role, department
  "recipient_email": "user@example.com",
  "recipient_phone": "+27123456789",

  // Message Content
  "title": "Maintenance Due",
  "message": "Vehicle CA-123-456 requires oil change",
  "short_message": "Maintenance due for CA-123-456",

  // Related Entities
  "related_entity_type": "maintenance_record",
  "related_entity_id": "maint_001",
  "vehicle_id": "vehicle_001",

  // Scheduling
  "scheduled_for": ISODate("2025-07-25T09:00:00Z"),
  "sent_at": ISODate("2025-07-25T09:00:00Z"),
  "read_at": null,

  // Delivery Information
  "delivery_methods": ["email", "in_app"],
  "delivery_status": {
    "email": "sent",
    "in_app": "pending",
    "sms": "not_configured"
  },

  // Metadata
  "created_at": ISODate("2025-07-17T10:00:00Z"),
  "expires_at": ISODate("2025-08-17T10:00:00Z"),
  "is_read": false,
  "is_actionable": true,

  // Action Information
  "action_url": "/maintenance/records/maint_001",
  "action_text": "View Details"
}
```

**Indexes:**

```javascript
{ "recipient_id": 1 }
{ "status": 1 }
{ "scheduled_for": 1 }
{ "notification_type": 1 }
{ "vehicle_id": 1 }
{ "related_entity_id": 1 }
{ "recipient_id": 1, "is_read": 1 }
{ "status": 1, "scheduled_for": 1 }
```

### 5. Vendors Collection (`vendors`)

**Service provider information**

```javascript
{
  "_id": ObjectId("..."),
  "vendor_id": "vendor_001",
  "vendor_name": "QuickLube Services",
  "vendor_type": "maintenance_service",

  // Contact Information
  "contact_person": "Sarah Johnson",
  "email": "sarah@quicklube.co.za",
  "phone": "+27123456789",
  "address": {
    "street": "123 Main Street",
    "city": "Cape Town",
    "province": "Western Cape",
    "postal_code": "8001",
    "country": "South Africa"
  },

  // Business Information
  "registration_number": "2020/123456/07",
  "tax_number": "9876543210",
  "business_type": "private_company",

  // Service Categories
  "services": [
    "oil_change",
    "tire_service",
    "brake_service",
    "general_maintenance"
  ],

  // Performance Metrics
  "rating": 4.5,
  "total_jobs": 150,
  "completed_jobs": 145,
  "average_cost": 275.00,
  "average_completion_time": 2.5,

  // Status
  "is_active": true,
  "is_preferred": false,
  "created_at": ISODate("2025-07-17T10:00:00Z"),
  "updated_at": ISODate("2025-07-17T10:00:00Z")
}
```

**Indexes:**

```javascript
{ "vendor_id": 1 }
{ "vendor_name": 1 }
{ "vendor_type": 1 }
{ "is_active": 1 }
{ "services": 1 }
```

## Database Interactions

### Repository Pattern

The service uses a repository pattern for database interactions:

```python
class MaintenanceRecordsRepository(BaseRepository):
    def __init__(self):
        super().__init__("maintenance_records")

    async def get_by_vehicle_id(self, vehicle_id: str, skip: int = 0, limit: int = 100):
        # Implementation with proper error handling

    async def get_overdue_maintenance(self):
        # Query for overdue records

    async def get_upcoming_maintenance(self, days_ahead: int = 7):
        # Query for upcoming maintenance
```

### Query Patterns

#### Complex Aggregation Queries

```javascript
// Cost analytics aggregation
db.maintenance_records.aggregate([
  {
    $match: {
      created_at: {
        $gte: ISODate('2025-01-01T00:00:00Z'),
        $lt: ISODate('2025-12-31T23:59:59Z'),
      },
    },
  },
  {
    $group: {
      _id: {
        year: { $year: '$created_at' },
        month: { $month: '$created_at' },
        maintenance_type: '$maintenance_type',
      },
      total_cost: { $sum: '$actual_cost' },
      count: { $sum: 1 },
      avg_cost: { $avg: '$actual_cost' },
    },
  },
  {
    $sort: { '_id.year': 1, '_id.month': 1 },
  },
]);
```

#### Overdue Maintenance Query

```javascript
db.maintenance_records.find({
  status: { $in: ['scheduled', 'in_progress'] },
  scheduled_date: { $lt: new Date() },
});
```

#### Upcoming Maintenance Query

```javascript
db.maintenance_records.find({
  status: 'scheduled',
  scheduled_date: {
    $gte: new Date(),
    $lte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
  },
});
```

### Transaction Management

```python
async def create_maintenance_with_schedule(maintenance_data: dict, schedule_data: dict):
    async with await db_manager.client.start_session() as session:
        async with session.start_transaction():
            # Create maintenance record
            maintenance_record = await maintenance_collection.insert_one(
                maintenance_data, session=session
            )

            # Update schedule
            await schedule_collection.update_one(
                {"_id": schedule_data["_id"]},
                {"$set": {"last_generated": datetime.utcnow()}},
                session=session
            )

            return maintenance_record
```

### Data Validation and Sanitization

```python
async def _prepare_document(self, data: Dict[str, Any]) -> Dict[str, Any]:
    """Prepare document for MongoDB insertion"""
    # Convert datetime.date to datetime objects for BSON compatibility
    for key, value in data.items():
        if isinstance(value, date) and not isinstance(value, datetime):
            data[key] = datetime.combine(value, datetime.min.time())

    return data
```

## Performance Optimization

### Index Strategy

- **Single field indexes**: For frequently queried fields
- **Compound indexes**: For multi-field queries
- **Text indexes**: For search functionality
- **TTL indexes**: For automatic cleanup of old notifications

### Query Optimization

- Use projection to limit returned fields
- Implement proper pagination with skip/limit
- Use aggregation pipelines for complex analytics
- Cache frequently accessed data

### Connection Management

- Connection pooling with min/max pool sizes
- Automatic connection retry with exponential backoff
- Health checks every 5 minutes
- Graceful connection cleanup on shutdown

## Data Backup and Recovery

### Backup Strategy

- Daily automated backups
- Point-in-time recovery capability
- Backup retention: 30 days
- Cross-region backup replication

### Recovery Procedures

- Automated failover to replica set
- Manual recovery from backup
- Data consistency checks
- Service health monitoring

## Security Considerations

### Access Control

- Database authentication required
- Role-based access control
- Connection encryption (TLS)
- Network security (VPC/firewall)

### Data Protection

- Sensitive data encryption
- PII handling compliance
- Audit logging
- Data retention policies

## Monitoring and Metrics

### Database Metrics

- Connection pool utilization
- Query response times
- Index usage statistics
- Storage utilization
- Error rates

### Application Metrics

- CRUD operation latencies
- Background job performance
- Cache hit rates
- Data consistency checks
