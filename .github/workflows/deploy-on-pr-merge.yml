name: Deploy on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - master
      - code-cleanup

jobs:
  deploy-on-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Deploy Merged PR via SAMDS API
        run: |
          echo "üîÄ PR #${{ github.event.number }} merged into ${{ github.base_ref }}"
          echo "Deploying merged changes..."
          
          # First pull the latest changes
          pull_response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
            -H "x-api-key: ${{ secrets.SAMDS_API_KEY }}" \
            "${{ secrets.SAMDS_ENDPOINT }}/pull")
          
          pull_http_code=$(echo $pull_response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          pull_body=$(echo $pull_response | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "Pull Response Code: $pull_http_code"
          
          if [ "$pull_http_code" != "200" ]; then
            echo "‚ùå Pull failed: $pull_body"
            exit 1
          fi
          
          # Then deploy
          deploy_response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
            -H "x-api-key: ${{ secrets.SAMDS_API_KEY }}" \
            "${{ secrets.SAMDS_ENDPOINT }}/deploy")
          
          deploy_http_code=$(echo $deploy_response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          deploy_body=$(echo $deploy_response | sed -e 's/HTTPSTATUS\:.*//g')
          
          echo "Deploy Response Code: $deploy_http_code"
          
          if [ "$deploy_http_code" = "200" ]; then
            echo "‚úÖ PR merge deployment successful!"
          else
            echo "‚ùå Deployment failed: $deploy_body"
            exit 1
          fi
