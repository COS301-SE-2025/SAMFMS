# SAMFMS Caddyfile with Let's Encrypt for samfms.co.za
# This will automatically get valid SSL certificates

{
    # Your email for Let's Encrypt notifications
    email admin@samfms.co.za
    # Use staging server for testing (comment out for production)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Redirect www to non-www
www.samfms.co.za {
    redir https://samfms.co.za{uri} permanent
}

# Main domain with automatic HTTPS
samfms.co.za {
    # API endpoints
    handle_path /api/* {
        reverse_proxy core:8000
    }
    
    # Health endpoints  
    handle_path /health/* {
        reverse_proxy core:8000
    }
    
    # Auth endpoints
    handle_path /auth/* {
        reverse_proxy core:8000
    }
    
    # WebSocket endpoints
    handle_path /ws/* {
        reverse_proxy core:8000
    }
    
    # Default: serve frontend
    handle {
        reverse_proxy frontend:3000
    }
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
}
